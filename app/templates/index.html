<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Treasury Yield Curve â€¢ Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body>
    <main class="container">
      <h1>Treasury Yield Curve <small id="asof" style="font-size: .6em; color: gray;"></small></h1>
      <div class="date-picker-row">
        <input
            type="date"
            id="datePicker"
            min="2018-01-01"/>
      </div>
      <div class="grid">
        <section>
            <div class="chart-wrap">
                <div id="chartLoading" class="chart-loading">Loading</div>
                <canvas id="yc"></canvas>
            </div>
        </section>
        <section class="sidebar">
          {% include "orders/form.html" %}
          {% include "orders/table.html" %}
        </section>
      </div>
    </main>

    <script>
      async function loadCurve(dateStr) {
        const url = new URL("{{ url_for('yields.api_yield_curve') }}", window.location.origin);
        if (dateStr) url.searchParams.set('date', dateStr);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch yield curve');
        return await res.json();
      }
      function showChartLoading() {
        const el = document.getElementById('chartLoading');
        if (el) el.style.display = 'flex';
      }
      function hideChartLoading() {
        const el = document.getElementById('chartLoading');
        if (el) el.style.display = 'none';
      }

      function chartConfig(labels, values) {
        return {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Par Yield (%)',
              data: values,
              tension: 0.25,
              fill: false,
              pointRadius: 4,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { title: { display: true, text: 'Yield (%)' }, beginAtZero: false },
              x: { title: { display: true, text: 'Maturity' } }
            }
          }
        }
      }
      (function setupOrderTypeTiming() {
        const typeSel   = document.getElementById('orderType');
        const timingSel = document.getElementById('timing');
        const limitRow  = document.getElementById('limitPriceRow');
        const limitInp  = document.getElementById('limitPrice');
        if (!typeSel || !timingSel || !limitRow || !limitInp) return;

        function setTimingOptions() {
            const t = typeSel.value;
            timingSel.innerHTML = '';
            const add = (v, text) => {
            const o = document.createElement('option');
            o.value = v; o.textContent = text;
            timingSel.appendChild(o);
            };

            if (t === 'MARKET') {
            add('DAY', 'Day only');
            timingSel.disabled = true;
            // Hide & clear limit price
            limitRow.style.display = 'none';
            limitInp.required = false;
            limitInp.value = '';
            } else {
            add('DAY', 'Day only');
            add('GTC', 'Good till canceled');
            add('FOK', 'Fill or Kill');
            timingSel.disabled = false;
            // Show limit price
            limitRow.style.display = '';
            limitInp.required = true;
            }
        }

        typeSel.addEventListener('change', setTimingOptions);
        setTimingOptions();
      })();
      function localTodayStr() {
        const d = new Date(); // local time
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      function isWeekend(yyyy_mm_dd) {
        const d = new Date(yyyy_mm_dd + 'T12:00:00');
        const dow = d.getDay(); // 0 Sun .. 6 Sat
        return dow === 0 || dow === 6;
      }

      function previousBusinessDay(yyyy_mm_dd) {
        const d = new Date(yyyy_mm_dd + 'T12:00:00');
        while ([0, 6].includes(d.getDay())) d.setDate(d.getDate() - 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      let chart;
      (async () => {
        try {
          showChartLoading();
          const data = await loadCurve();
          document.getElementById('asof').textContent = `updated just now`;
          document.getElementById('datePicker').value = data.date;
          document.getElementById('datePicker').max = localTodayStr();
          const labels = data.points.map(p => p.term);
          const values = data.points.map(p => p.value);
          const ctx = document.getElementById('yc');
          chart = new Chart(ctx, chartConfig(labels, values));
        } catch (e) {
          console.error(e);
        } finally {
          hideChartLoading();
        }
      })();
      const dp = document.getElementById('datePicker');
      dp.addEventListener('change', async (e) => {
        const today = localTodayStr();
        let selected = e.target.value;
        if (!selected) return;

        // Disallow future dates
        if (selected > today) {
            selected = today;
            dp.value = selected;
        }

        if (isWeekend(selected)) {
            const prevBiz = previousBusinessDay(selected);
            alert(`Weekends are not selectable. Using previous business day: ${prevBiz}`);
            selected = prevBiz;
            dp.value = selected;
        }

        try {
            showChartLoading();
            const data = await loadCurve(selected);
            const served = String(data.date).slice(0, 10);

            if (selected === today && served !== today) {
            alert('Data not yet released for today. Check back soon.');
            }

            const labels = data.points.map(p => p.term);
            const values = data.points.map(p => p.value);
            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update();

            dp.value = served;
        } catch (err) {
            console.error(err);
        } finally {
          hideChartLoading();
        }
      });
    </script>
  </body>
</html>